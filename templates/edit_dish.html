{% extends "base.html" %}
{% block content %}
<style>
    .form-group {
        margin-bottom: 1.5rem;
        width: 100%;
    }
    .form-control {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
    }
    input[type="text"],
    input[type="number"], 
    textarea, 
    select {
        width: 100%;
        min-width: 300px;
        max-width: 800px;
        padding: 8px;
        margin-top: 5px;
    }
    textarea {
        min-height: 100px;
    }
    .ingredient-form {
        display: flex;
        gap: 10px;
        align-items: center;
        max-width: 1200px;  /* Verhoog maximum breedte */
        margin-bottom: 20px;
    }
    .ingredient-form select#categorie_filter {
        flex: 1;  /* Categorie filter neemt normaal deel */
    }
    .ingredient-form select#ingredient_id {
        flex: 3;  /* Ingrediënt selector krijgt 3x zoveel ruimte */
    }
    .ingredient-form input {
        flex: 0.5;  /* Hoeveelheid input krijgt maar half deel */
        max-width: 100px;  /* Maximum breedte voor hoeveelheid */
        min-width: unset;  /* Override de algemene min-width */
    }
    .ingredient-form button {
        white-space: nowrap;
        flex: 0.5;  /* Knop krijgt ook maar half deel */
    }
</style>

<h2>Gerecht Bewerken: {{ gerecht.naam }}</h2>
<p>Categorie: {{ gerecht.categorie }}</p>
<p>Verkoopprijs: {{ gerecht.verkoopprijs if gerecht.verkoopprijs else 'n.v.t.' }}</p>

<!-- Formulier om alle velden bij te werken -->
<form method="POST" action="{{ url_for('edit_dish', chef_naam=chef_naam, dish_id=gerecht.dish_id) }}">
    <input type="hidden" name="updateForm" value="1">

    <div class="form-group">
        <h3>Naam bijwerken</h3>
        <input type="text" id="naam" name="naam" value="{{ gerecht.naam }}" class="form-control" required>
    </div>

    <div class="form-group">
        <h3>Beschrijving bijwerken</h3>
        <textarea id="beschrijving" name="beschrijving" class="form-control" required>{{ gerecht.beschrijving if gerecht.beschrijving else '' }}</textarea>
    </div>

    <div class="form-group">
        <h3>Categorie bijwerken</h3>
        <select id="gerecht_categorie" name="gerecht_categorie" class="form-control" required>
            <option value="Amuse-bouche" {% if gerecht.categorie == 'Amuse-bouche' %}selected{% endif %}>Amuse-bouche (optioneel)</option>
            <option value="Hors-d'œuvre" {% if gerecht.categorie == "Hors-d'œuvre" %}selected{% endif %}>Hors-d'œuvre (koud voorgerecht)</option>
            <option value="Potage" {% if gerecht.categorie == 'Potage' %}selected{% endif %}>Potage (soep)</option>
            <option value="Poisson" {% if gerecht.categorie == 'Poisson' %}selected{% endif %}>Poisson (visgerecht)</option>
            <option value="Entrée" {% if gerecht.categorie == 'Entrée' %}selected{% endif %}>Entrée (warm voorgerecht / tussengerecht)</option>
            <option value="Sorbet" {% if gerecht.categorie == 'Sorbet' %}selected{% endif %}>Sorbet (verfrissende gang)</option>
            <option value="Relevé of Rôti" {% if gerecht.categorie == 'Relevé of Rôti' %}selected{% endif %}>Relevé of Rôti (hoofdgerecht/vleesgerecht)</option>
            <option value="Légumes / Groentegerecht" {% if gerecht.categorie == 'Légumes / Groentegerecht' %}selected{% endif %}>Légumes / Groentegerecht (optioneel apart geserveerd)</option>
            <option value="Salade" {% if gerecht.categorie == 'Salade' %}selected{% endif %}>Salade (optioneel apart)</option>
            <option value="Fromage" {% if gerecht.categorie == 'Fromage' %}selected{% endif %}>Fromage (kaas)</option>
            <option value="Entremets" {% if gerecht.categorie == 'Entremets' %}selected{% endif %}>Entremets (zoet nagerecht)</option>
            <option value="Café / Mignardises" {% if gerecht.categorie == 'Café / Mignardises' %}selected{% endif %}>Café / Mignardises</option>
            <option value="Digestief" {% if gerecht.categorie == 'Digestief' %}selected{% endif %}>Digestief (optioneel)</option>
            <option value="Basisgerecht" {% if gerecht.categorie == 'Basisgerecht' %}selected{% endif %}>Basisgerecht</option>
        </select>
    </div>

    <div class="form-group">
        <h3>Bereidingswijze bijwerken</h3>
        <textarea id="bereidingswijze" name="bereidingswijze" class="form-control">{{ gerecht.bereidingswijze if gerecht.bereidingswijze else '' }}</textarea>
    </div>

    <button type="submit" class="btn btn-primary">Opslaan</button>
</form>

<hr>

<h3>Ingrediënten toevoegen</h3>
<form method="POST" action="{{ url_for('edit_dish', chef_naam=chef_naam, dish_id=gerecht.dish_id) }}" class="ingredient-form">
    <input type="hidden" name="ingredientForm" value="1">
    
    <select id="categorie_filter" class="form-control" onchange="filterIngredients()">
        <option value="">Alle categorieën</option>
        {% set categories = [] %}
        {% for ingr in alle_ingredienten %}
            {% if ingr.categorie not in categories %}
                {% set _ = categories.append(ingr.categorie) %}
                <option value="{{ ingr.categorie }}">{{ ingr.categorie }}</option>
            {% endif %}
        {% endfor %}
    </select>
    
    <select id="ingredient_id" name="ingredient_id" class="form-control" required>
        <option value="" disabled selected>Selecteer Ingrediënt</option>
        {% for ingr in alle_ingredienten %}
        <option value="{{ ingr.ingredient_id }}" data-category="{{ ingr.categorie }}">
            {{ ingr.naam }} ({{ ingr.eenheid }}) - €{{ ingr.prijs_per_eenheid }} per {{ ingr.eenheid }}
        </option>
        {% endfor %}
    </select>

    <input type="number" step="0.01" id="hoeveelheid" name="hoeveelheid" class="form-control" required placeholder="Hoeveelheid">

    <button type="submit" class="btn btn-primary">Ingrediënt toevoegen</button>
</form>

<script>
function filterIngredients() {
    const categoryFilter = document.getElementById('categorie_filter').value;
    const ingredientSelect = document.getElementById('ingredient_id');
    const options = ingredientSelect.getElementsByTagName('option');

    for (let option of options) {
        if (option.value === "") continue; // Skip the placeholder option
        if (!categoryFilter || option.getAttribute('data-category') === categoryFilter) {
            option.style.display = '';
        } else {
            option.style.display = 'none';
        }
    }
    
    // Reset ingredient selection
    ingredientSelect.value = "";
}
</script>

<hr>

<!-- Lijst van ingrediënten die al zijn gekoppeld aan dit gerecht -->
<h3>Kostprijsberekening:</h3>
<div id="ingredienten-tabel">  <!-- Voeg deze div met ID toe -->
{% if gerecht_ingredienten %}
<table border="1" cellpadding="5" cellspacing="0">
    <tr>
        <th>Ingrediënt</th>
        <th>Hoeveelheid</th>
        <th>Eenheid</th>
        <th>Prijs Totaal</th>
        <th>Acties</th>
    </tr>
    {% for gi in gerecht_ingredienten %}
    <tr>
        <td>{{ gi.ingredient_naam }}</td>
        <td>
            <form method="POST" action="{{ url_for('update_dish_ingredient', chef_naam=chef_naam, dish_id=gerecht.dish_id, ingredient_id=gi.ingredient_id) }}" style="display: inline;"></form>
                <input type="number" step="0.01" name="nieuwe_hoeveelheid" value="{{ gi.hoeveelheid }}" style="width: 70px;">
                <button type="submit" class="small-button">Update</button>
            </form>
        </td>
        <td>{{ gi.eenheid }}</td>
        <td>{{ gi.prijs_totaal }}</td>
        <td>
            <a href="{{ url_for('edit_ingredient', chef_naam=chef_naam, ingredient_id=gi.ingredient_id) }}" class="small-button">
                <button type="button" class="small-button">Bewerk Ingredient</button>
            </a>
            <form method="POST" action="{{ url_for('remove_dish_ingredient', chef_naam=chef_naam, dish_id=gerecht.dish_id, ingredient_id=gi.ingredient_id) }}" style="display: inline;" onsubmit="return confirm('Weet u zeker dat u dit ingrediënt wilt verwijderen?');">
                <button type="submit" class="small-button">Verwijderen</button>
            </form>
        </td>
    </tr>
    {% endfor %}
</table>
<p><strong>Totaal kostprijs: € {{ totaal_ingredient_prijs }}</strong></p>

<hr>

<h3>Verkoopprijs bijwerken</h3>
<div id="verkoopprijs-sectie">
    <form method="POST" action="{{ url_for('edit_dish', chef_naam=chef_naam, dish_id=gerecht.dish_id) }}">
        <input type="hidden" name="priceForm" value="1">
        <input type="number" step="0.01" id="verkoopprijs" name="verkoopprijs" value="{{ gerecht.verkoopprijs }}" class="form-control" style="max-width: 200px; display: inline-block;">
        <button type="submit" class="btn btn-primary">Verkoopprijs Opslaan</button>
    </form>
</div>

{% else %}
<p>Er zijn nog geen ingrediënten aan dit gerecht toegevoegd.</p>
{% endif %}
</div>

<hr>

<a href="{{ url_for('all_dishes') }}">Terug naar Gerechtenoverzicht</a>
{% endblock %}
