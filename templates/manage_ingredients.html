{% extends "base.html" %}
{% block content %}
<h2>Ingrediënten Beheren</h2>
<p>Voeg nieuwe ingrediënten toe of bekijk bestaande ingrediënten.</p>

<div class="navigation-buttons" style="margin-bottom: 20px;">
    <a href="{{ url_for('dashboard', chef_naam=chef_naam) }}" class="btn-action">
        <i class="fas fa-arrow-left"></i> Dashboard
    </a>
    <button onclick="recalculatePrices()" class="btn-action">
        <i class="fas fa-calculator"></i> Herbereken alle kostprijzen
    </button>
</div>

<!-- Nieuw ingrediënt formulier -->
<div class="add-ingredient-form" style="margin-top: 20px;">
    <h3>Nieuw Ingrediënt Toevoegen</h3>
    <form method="POST" class="ingredient-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="form-group">
            <input type="text" name="naam" placeholder="Naam" required class="form-control">
        </div>
        <div class="form-group">
            <select name="categorie" class="form-control">
            <option value="">Kies categorie</option>
            {% for categorie in categorieen %}
                <option value="{{ categorie.naam }}">{{ categorie.naam }}</option>
            {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <select name="eenheid" class="form-control">
            <option value="">Kies eenheid</option>
            {% for eenheid in eenheden %}
                <option value="{{ eenheid.naam }}">{{ eenheid.naam }}</option>
            {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <input type="number" name="prijs_per_eenheid" placeholder="Prijs per eenheid" step="0.01" required class="form-control">
            <select name="leverancier_id" class="form-control">
                <option value="">Kies leverancier</option>
                {% for leverancier in leveranciers %}
                    <option value="{{ leverancier.leverancier_id }}">{{ leverancier.naam }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn-action"><i class="fas fa-plus"></i> Toevoegen</button>
    </form>
</div>


<div class="search-filter">
    <input type="text" id="ingredientSearch" class="form-control" 
           placeholder="Zoek ingrediënt..." style="max-width: 300px; display: inline-block;">
    <select id="categoryFilter" class="form-control" style="max-width: 300px; display: inline-block">
        <option value="">Filter op...</option>
        {% for categorie in unieke_categorieen %} 
            <option value="{{ categorie }}">{{ categorie }}</option>
        {% endfor %}
    </select>
</div>

<!-- Ingrediënten tabel -->
<table class="ingredient-table" border="1" cellpadding="5" cellspacing="0">
    <tr>
        <th>Ingrediënt</th>
        <th>Categorie</th>
        <th>Eenheid</th>
        <th>Leverancier</th>
        <th class="col-price">Prijs per eenheid</th>
        <th class="col-actions">Acties</th>
    </tr>
    {% for ingredient in ingredienten %}
    <tr data-ingredient-id="{{ ingredient.ingredient_id }}">
        <td>{{ ingredient.naam }}</td>
        <td>
            <select class="inline-edit form-control" name="categorie" data-original="{{ ingredient.categorie }}">
                {% for categorie in categorieen %}
                    <option value="{{ categorie.naam }}" {% if ingredient.categorie == categorie.naam %}selected{% endif %}>
                        {{ categorie.naam }}
                    </option>
                {% endfor %}
            </select>
        </td>
        <td>
            <select class="inline-edit form-control" name="eenheid" data-original="{{ ingredient.eenheid }}">
                {% for eenheid in eenheden %}
                    <option value="{{ eenheid.naam }}" {% if ingredient.eenheid == eenheid.naam %}selected{% endif %}>
                        {{ eenheid.naam }}
                    </option>
                {% endfor %}
            </select>
        </td>
        <td>
            <select class="inline-edit form-control" name="leverancier_id" data-original="{{ ingredient.leverancier_id }}">
                <option value="">Geen leverancier</option>
                {% for leverancier in leveranciers %}
                    <option value="{{ leverancier.leverancier_id }}" {% if ingredient.leverancier_id == leverancier.leverancier_id %}selected{% endif %}>
                        {{ leverancier.naam }}
                    </option>
                {% endfor %}
            </select>
        </td>
        <td class="col-price">
            <div class="ingredient-price-group" style="display: flex; align-items: center;">
                <span style="margin-right: 4px;">€</span>
                <input type="text" 
                       pattern="[0-9]*[.,]?[0-9]{0,2}"
                       inputmode="decimal"
                       class="inline-edit form-control price-input"
                       name="prijs_per_eenheid"
                       value="{{ '%.2f'|format(ingredient.prijs_per_eenheid|float) }}"
                       data-original="{{ ingredient.prijs_per_eenheid }}"
                       style="width: 100px; text-align: right;">
            </div>
        </td>
        <td class="col-actions">
            <div class="ingredient-actions">
                <button class="btn-action btn-save" onclick="saveField(this)" title="Opslaan">
                    <i class="fas fa-save"></i>
                </button>
                <form method="POST" action="{{ url_for('delete_ingredient', chef_naam=chef_naam, ingredient_id=ingredient.ingredient_id) }}" 
                      style="display: inline;" 
                      onsubmit="return confirm('Weet u zeker dat u dit ingrediënt wilt verwijderen?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn-action btn-delete" title="Verwijderen">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </form>
            </div>
        </td>
    </tr>
    {% endfor %}
</table>

<!-- CSV import sectie -->
<div class="csv-import" style="margin-top: 20px;">
    <h3>Bulk Import via CSV</h3>
    <form method="POST" action="{{ url_for('bulk_add_ingredients', chef_naam=chef_naam) }}" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="form-group">
            <input type="file" name="csv_file" accept=".csv" required class="form-control">
        </div>
        <button type="submit" class="btn-action"><i class="fas fa-file-import"></i> Importeren</button>
        <a href="{{ url_for('download_csv_template') }}" class="btn-action">
            <i class="fas fa-download"></i> Download Template
        </a>
    </form>
</div>

<div class="mobile-bulk-import-message">
    Log aan op je laptop om bulkwijzigingen te doen.
</div>

<style>
    /* Verberg de CSV import sectie op kleine schermen */
    @media (max-width: 768px) {
        .csv-import {
            display: none;
        }
        .mobile-bulk-import-message {
            text-align: center;
            margin-top: 20px;
            font-style: italic;
        }
    }

    /* Stijlen voor grotere schermen */
    @media (min-width: 769px) {
        .mobile-bulk-import-message {
            display: none;
        }
    }

    .inline-edit {
        border: 1px solid transparent;
        background-color: transparent;
        padding: 2px 4px;
        width: 100%;
        min-width: 100px;
    }

    .inline-edit:hover, .inline-edit:focus {
        border-color: var(--kitchen-steel);
        background-color: var(--kitchen-dark);
    }

    .inline-edit.modified {
        background-color: rgba(255, 255, 0, 0.1);
    }

    .save-indicator {
        margin-left: 5px; /* Adjust spacing as needed */
    }

    .input-group {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .save-btn {
        background: none;
        border: none;
        color: var(--kitchen-blue);
        cursor: pointer;
        padding: 5px;
        display: none;
    }

    .save-btn:hover {
        color: var(--kitchen-highlight);
    }

    .modified {
        background-color: rgba(255, 255, 0, 0.1);
    }

    .btn-save {
        background: none;
        border: none;
        color: var(--kitchen-blue);
        cursor: pointer;
        padding: 5px;
        opacity: 0.5; /* Maak de knop wat doorzichtig wanneer er geen wijzigingen zijn */
    }

    .btn-save.active {
        opacity: 1; /* Maak de knop volledig zichtbaar als er wijzigingen zijn */
    }

    .ingredient-actions {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .price-input {
        text-align: right !important;
        padding-right: 8px !important;
        min-width: 100px !important;
        width: 100px !important;
    }

    .ingredient-price-group {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .btn-save {
        opacity: 0.5;
        transition: opacity 0.3s ease;
    }

    .btn-save.active {
        opacity: 1;
        color: var(--kitchen-highlight);
    }
</style>


<script>
    // Zoek en filter functionaliteit
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('ingredientSearch');
        const categoryFilter = document.getElementById('categoryFilter');
        const table = document.querySelector('.ingredient-table');
        const rows = table.getElementsByTagName('tr');

        function filterTable() {
            const searchTerm = searchInput.value.toLowerCase();
            const category = categoryFilter.value.toLowerCase();

            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const name = row.cells[0].textContent.toLowerCase();
                const rowCategory = row.cells[1].textContent.toLowerCase();
                
                const matchesSearch = name.includes(searchTerm);
                const matchesCategory = category === '' || rowCategory === category;

                row.style.display = matchesSearch && matchesCategory ? '' : 'none';
            }
        }

        searchInput.addEventListener('input', filterTable);
        categoryFilter.addEventListener('change', filterTable);

        // Initialize all price inputs
        document.querySelectorAll('.price-input').forEach(input => {
            input.addEventListener('input', function(e) {
                // Replace comma with dot for consistency
                let value = this.value.replace(',', '.');
                
                // Remove any non-numeric chars except the decimal point
                value = value.replace(/[^\d.]/g, '');
                
                // Ensure only one decimal point
                let parts = value.split('.');
                if (parts.length > 2) {
                    value = parts[0] + '.' + parts.slice(1).join('');
                }
                
                // Update the input value
                this.value = value;

                // Mark as modified
                const row = this.closest('tr');
                const saveBtn = row.querySelector('.btn-save');
                const originalValue = this.dataset.original;
                
                if (value !== originalValue) {
                    this.classList.add('modified');
                    saveBtn.classList.add('active');
                } else {
                    this.classList.remove('modified');
                    if (!row.querySelector('.modified')) {
                        saveBtn.classList.remove('active');
                    }
                }
            });

            // Only format when leaving the field
            input.addEventListener('blur', function() {
                if (this.value) {
                    try {
                        const numValue = parseFloat(this.value);
                        if (!isNaN(numValue)) {
                            this.value = numValue.toFixed(2);
                        }
                    } catch (e) {
                        console.error('Error formatting price:', e);
                    }
                }
            });
        });

        // Initialize all select inputs
        document.querySelectorAll('select.inline-edit').forEach(select => {
            select.addEventListener('change', function() {
                const row = this.closest('tr');
                const saveBtn = row.querySelector('.btn-save');
                const originalValue = this.dataset.original;
                
                if (this.value !== originalValue) {
                    this.classList.add('modified');
                    saveBtn.classList.add('active');
                } else {
                    this.classList.remove('modified');
                    if (!row.querySelector('.modified')) {
                        saveBtn.classList.remove('active');
                    }
                }
            });
        });
    });

    // Global save function
    window.saveField = async function(button) {
        const row = button.closest('tr');
        const modifiedInput = row.querySelector('.modified');
        
        if (!modifiedInput) return;
        
        const ingredient_id = row.dataset.ingredientId;
        const fieldName = modifiedInput.name;
        let newValue = modifiedInput.value;
        
        try {
            const response = await fetch(`/dashboard/{{ chef_naam }}/ingredients/${ingredient_id}/update-field`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': "{{ csrf_token() }}"
                },
                body: JSON.stringify({
                    field: fieldName,
                    value: newValue
                })
            });

            const result = await response.json();
            if (result.success) {
                modifiedInput.dataset.original = result.value;
                modifiedInput.classList.remove('modified');
                button.classList.remove('active');
                // Show success message
                const flashDiv = document.createElement('div');
                flashDiv.className = 'alert alert-success';
                flashDiv.innerHTML = "Wijziging opgeslagen!";
                document.querySelector('.container').insertAdjacentElement('afterbegin', flashDiv);
                setTimeout(() => flashDiv.remove(), 3000);
            } else {
                throw new Error(result.error);
            }
        } catch (error) {
            console.error('Error:', error);
            modifiedInput.value = modifiedInput.dataset.original;
            modifiedInput.classList.remove('modified');
            button.classList.remove('active');
            // Show error message
            const flashDiv = document.createElement('div');
            flashDiv.className = 'alert alert-danger';
            flashDiv.innerHTML = "Fout bij opslaan: " + error.message;
            document.querySelector('.container').insertAdjacentElement('afterbegin', flashDiv);
            setTimeout(() => flashDiv.remove(), 3000);
        }
    };

    async function recalculatePrices() {
        if (!confirm('Wilt u alle kostprijzen herberekenen? Dit kan even duren.')) {
            return;
        }
        
        try {
            const response = await fetch(`/dashboard/{{ chef_naam }}/recalculate-prices`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': "{{ csrf_token() }}"
                }
            });
            
            const result = await response.json();
            if (result.success) {
                const flashDiv = document.createElement('div');
                flashDiv.className = 'alert alert-success';
                flashDiv.innerHTML = `Kostprijzen herberekend! ${result.updated_dishes} gerechten bijgewerkt.`;
                document.querySelector('.container').insertAdjacentElement('afterbegin', flashDiv);
                setTimeout(() => flashDiv.remove(), 5000);
            } else {
                throw new Error(result.error);
            }
        } catch (error) {
            const flashDiv = document.createElement('div');
            flashDiv.className = 'alert alert-danger';
            flashDiv.innerHTML = "Fout bij herberekenen: " + error.message;
            document.querySelector('.container').insertAdjacentElement('afterbegin', flashDiv);
            setTimeout(() => flashDiv.remove(), 5000);
        }
    }
</script>
{% endblock %}
